name: CI/CD Pipeline

on:
  push:
    branches: [main, master, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  # ========================================
  # Version Synchronization Check
  # ========================================
  version-sync-check:
    name: Version Sync Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check version consistency
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          MANIFEST_VERSION=$(node -p "require('./manifest.json').version")

          echo "üì¶ package.json version: $PACKAGE_VERSION"
          echo "üìã manifest.json version: $MANIFEST_VERSION"

          if [ "$PACKAGE_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "‚ùå ERROR: Version mismatch detected!"
            echo "   package.json: $PACKAGE_VERSION"
            echo "   manifest.json: $MANIFEST_VERSION"
            echo ""
            echo "üí° Fix: Update both versions to match before committing."
            echo "   See CLAUDE.md for release checklist."
            exit 1
          fi

          echo "‚úÖ Version sync check passed: $PACKAGE_VERSION"

  # ========================================
  # Lint and Type Check
  # ========================================
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: version-sync-check
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Biome linting
        run: npm run lint

      - name: Run TypeScript type checking
        run: npx tsc --noEmit

      - name: Build project
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # ========================================
  # Unit Tests (Fast, No Docker)
  # ========================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  # ========================================
  # Integration Tests (Docker via Vitest globalSetup)
  # ========================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration

  # ========================================
  # Contract Tests (Docker via Vitest globalSetup)
  # ========================================
  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run contract tests
        run: npm run test:contract

  # ========================================
  # Bundle and Package (MCPB)
  # ========================================
  bundle-and-package:
    name: Bundle & Package
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration, contract-tests]
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install production dependencies only
        run: npm ci --omit=dev

      - name: Create MCPB bundle
        run: npx @anthropic-ai/mcpb pack

      - name: Verify bundle was created
        run: |
          if [ ! -f grist-mcp-server.mcpb ]; then
            echo "‚ùå ERROR: MCPB bundle was not created!"
            exit 1
          fi

          BUNDLE_SIZE=$(du -h grist-mcp-server.mcpb | cut -f1)
          echo "‚úÖ MCPB bundle created successfully"
          echo "üì¶ Bundle size: $BUNDLE_SIZE"
          ls -lh grist-mcp-server.mcpb

      - name: Upload MCPB bundle
        uses: actions/upload-artifact@v4
        with:
          name: mcpb-bundle
          path: grist-mcp-server.mcpb
          retention-days: 30

  # ========================================
  # Quality Gates (Final Verification)
  # ========================================
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration, contract-tests, bundle-and-package]
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download MCPB bundle
        uses: actions/download-artifact@v5
        with:
          name: mcpb-bundle

      - name: Extract version info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version: $VERSION"
        id: version

      - name: Quality gate summary
        run: |
          echo "## ‚úÖ All Quality Gates Passed!"
          echo ""
          echo "### Build Information"
          echo "- **Version:** ${{ steps.version.outputs.version }}"
          echo "- **Node Version:** ${{ env.NODE_VERSION }}"
          echo "- **Commit:** ${{ github.sha }}"
          echo "- **Branch:** ${{ github.ref_name }}"
          echo ""
          echo "### Completed Checks"
          echo "- ‚úÖ Version synchronization (package.json ‚Üî manifest.json)"
          echo "- ‚úÖ Biome linting and formatting"
          echo "- ‚úÖ TypeScript type checking"
          echo "- ‚úÖ Build compilation"
          echo "- ‚úÖ Unit tests"
          echo "- ‚úÖ Integration tests (Docker)"
          echo "- ‚úÖ Contract tests (Grist API compatibility)"
          echo "- ‚úÖ MCPB bundle generation"
          echo ""
          echo "### Artifacts"
          echo "- üì¶ MCPB Bundle: \`grist-mcp-server.mcpb\`"
          echo "- üìÅ Build Output: \`dist/\`"
          echo ""
          echo "**Ready for deployment!** üöÄ"

  # ========================================
  # Automated Release (Tag-triggered)
  # ========================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [quality-gates]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download MCPB bundle
        uses: actions/download-artifact@v5
        with:
          name: mcpb-bundle

      - name: Extract version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Release version: $VERSION"
        id: version

      - name: Extract changelog for this version
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if [ -f CHANGELOG.md ]; then
            # Extract changelog section for this version
            awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | grep -v "^## \[" | tail -n +1 > release-notes.md

            if [ -s release-notes.md ]; then
              echo "‚úÖ Extracted changelog for version $VERSION"
              cat release-notes.md
            else
              echo "‚ö†Ô∏è No changelog entry found for version $VERSION"
              echo "Release for Grist MCP Server v$VERSION" > release-notes.md
            fi
          else
            echo "‚ö†Ô∏è CHANGELOG.md not found"
            echo "Release for Grist MCP Server v$VERSION" > release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            grist-mcp-server.mcpb
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## üéâ Release Created Successfully!"
          echo ""
          echo "- **Version:** v${{ steps.version.outputs.version }}"
          echo "- **Tag:** ${{ github.ref_name }}"
          echo "- **Bundle:** grist-mcp-server.mcpb"
          echo ""
          echo "üîó View release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

  # ========================================
  # Publish to npm Registry
  # ========================================
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [quality-gates]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Verify version matches tag
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION=${GITHUB_REF#refs/tags/v}

          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "‚ùå ERROR: package.json version ($PACKAGE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi

          echo "‚úÖ Version verified: $PACKAGE_VERSION"

      - name: Publish to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish summary
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "## üì¶ Published to npm!"
          echo ""
          echo "- **Package:** grist-mcp-server@$VERSION"
          echo "- **Registry:** https://www.npmjs.com/package/grist-mcp-server"
          echo ""
          echo "Install with: \`npx grist-mcp-server\`"
